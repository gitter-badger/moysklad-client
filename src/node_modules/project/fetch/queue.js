var sleep = require('project/sleep');

var Queue = function (options) {
    options = options || {};

    this.requestPeriod = options.requestPeriod || 1000;
    this.requestsPerPeriod = options.requestsPerPeriod || 5;
    this.parallelTaskCount = options.parallelTaskCount || 2;
    this.async = 'async' in options ? !!options.async : true;

    this._timeline = [];
    this._tasksInProgress = 0;
    this._queue = []
};

Queue.prototype.addTask = function (task, cb) {
    if (!cb && this.async) {
        throw new Error('Queue.addTask: callback must be defined in async mode');
    }
    this._queue.push({ action: task, cb: cb });
    return this._processQueueTask()
};

Queue.prototype._processQueueTask = function () {
    var that = this;
    if (this._tasksInProgress < this.parallelTaskCount && this._queue.length > 0) {
        var curTime = new Date();

        while (this._timeline.length) {
            // -r1-r2-[-r3--r4-r5----------*]
            if (curTime - this._timeline[0] > this.requestPeriod) {
                this._timeline.shift()
            }
            // -------[-r3--r4-r5----------*]
            else {
                break
            }
        }

        // [r1-r2---r3--r4-r5--*--]
        if (this._timeline.length >= this.requestsPerPeriod) {
            var waitTime = this.requestPeriod - (curTime - this._timeline[0]);
            return sleep(waitTime, this.async, this._processQueueTask.bind(this))
        }
        // else
        // [r1-r2---r3---------*--]

        var task = this._queue.shift();
        this._tasksInProgress++;
        this._timeline.push(new Date());

        var result;
        task.action(function (err, data) {
            that._tasksInProgress--;
            if (task.cb) {
                task.cb.apply(null, arguments);
                that._processQueueTask()
            } else {
                if (err) {
                    throw err;
                } else {
                    result = data;
                }
            }
        });
        return result;
    }
};

module.exports = Queue;


